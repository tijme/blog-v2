<!DOCTYPE html><html lang="en"><head><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge" /><meta name="viewport" content="width=device-width, initial-scale=1" /><link rel="stylesheet" href="/css/template.css?version=2.0.1" /><link rel="shortcut icon" href="/img/favicon.svg?version=2.0.1" type="image/svg+xml" /> <script src="/js/template.js?version=2.0.1"></script><meta name="theme-color" content="#e6e6e6" media="(prefers-color-scheme: light)" /><meta name="theme-color" content="#e6e6e6" media="(prefers-color-scheme: dark)" /><title>Scamming people via Ethereum smart contracts</title><meta property="og:title" content="Scamming people via Ethereum smart contracts"><meta name="description" itemprop="description" content="Strange features in the Solidity programming language allow scammers to create faulty smart contracts (honeypots) on the ethereum blockchain."><meta property="og:description" content="Strange features in the Solidity programming language allow scammers to create faulty smart contracts (honeypots) on the ethereum blockchain."><meta name="keywords" content="ethereum, blockchain, smart, contract, faulty, scam, scamming, hack, steal, money, guess, the, word, game, honeypot"><meta name="language" content="english"><meta name="author" itemprop="creator" content="Tijme Gommers"><meta name="robots" content="index, follow"><meta name="distribution" content="global"><meta name="copyright" content="Copyright © 2024 Tijme Gommers. All rights reserved."><link rel="alternate" type="application/rss+xml" title="Atom" href="/feeds/atom.xml"></head><body><div class="navbar-wrapper mb-4"><div class="container"><div class="row justify-content-center"><div class="col-12 col-sm-12 col-md-12 col-lg-11 col-xl-8 col-xll-6"><nav class="navbar navbar-expand"><div class="collapse navbar-collapse"><ul class="navbar-nav me-auto"><li class="nav-item"> <a href="/" target="_self" class="nav-link"> <span>Posts</span> </a></li><li class="nav-item"> <a href="/about/" target="_self" class="nav-link"> <span>About</span> </a></li><li class="nav-item"> <a href="/donate/" target="_self" class="nav-link"> <span>Donate</span> </a></li></ul><ul class="navbar-nav"><li class="nav-item"> <a href="https://twitter.com/tijme" target="_blank" rel="noopener noreferrer" class="nav-link"> <span><span class="icon"> <svg><use xlink:href="/img/icons.svg#twitter"/></svg> </span></span> </a></li><li class="nav-item d-none d-sm-block"> <a href="https://www.linkedin.com/in/tijme/" target="_blank" rel="noopener noreferrer" class="nav-link"> <span><span class="icon"> <svg><use xlink:href="/img/icons.svg#linkedin"/></svg> </span></span> </a></li><li class="nav-item d-none d-sm-block"> <a href="https://github.com/tijme/" target="_blank" rel="noopener noreferrer" class="nav-link"> <span><span class="icon"> <svg><use xlink:href="/img/icons.svg#github"/></svg> </span></span> </a></li><li class="nav-item d-none d-sm-block"> <a href="/feeds/atom.xml" target="_blank" class="nav-link"> <span><span class="icon"> <svg><use xlink:href="/img/icons.svg#rss"/></svg> </span></span> </a></li></ul></div></nav></div></div></div></div><div class="container"><div class="row justify-content-center"><div class="col-12 col-sm-12 col-md-12 col-lg-11 col-xl-8 col-xll-6"><article class="container-fluid"><h1 class="mb-2">Scamming people via Ethereum smart contracts</h1><p class="mb-2 text-muted">Posted on <time datetime="2018-04-30T00:00:00+00:00">30 April 2018</time> by Tijme Gommers.</p><p><strong>[TL;DR]</strong> Using a ‘feature’ in the Solidity programming language it is possible to create smart contracts on the Ethereum blockchain that look completely legit; however, everyone that sends money to the contract can never get it back due to that ‘feature’.</p><hr /><p>Alright, lets dive right into it. The code snippet below is an <a href="https://www.ethereum.org/" target="_blank" rel="noopener noreferrer">Ethereum</a> <a href="https://en.wikipedia.org/wiki/Smart_contract" target="_blank" rel="noopener noreferrer">smart contract</a> written in <a href="https://solidity.readthedocs.io/" target="_blank" rel="noopener noreferrer">Solidity</a>. If you do not understand any of those terms, click on the links to get more information.</p><p>Before you try to work out how the contract works, let me tell you it’s a scam contract that contains a Solidity ‘feature’ that causes unexpected behaviour. Below the code snippet you can find an extensive <a href="#explanation">explanation</a> of the contract. The actual contract can be found on <a href="https://etherscan.io/address/0x9823e4e4f4552cd84720dabbd6fb2c7b67066c6c#code" target="_blank" rel="noopener noreferrer">Etherscan</a>.</p><figure class="highlight"><pre><code class="language-solidity" data-lang="solidity"><span class="k">pragma</span> <span class="n">solidity</span> <span class="o">^</span><span class="mf">0.4</span><span class="p">.</span><span class="mi">23</span><span class="p">;</span>

<span class="k">contract</span> <span class="n">NumberBetweenZeroAndTen</span> <span class="p">{</span>

    <span class="kt">uint256</span> <span class="k">private</span> <span class="n">secretNumber</span><span class="p">;</span>
    <span class="kt">uint256</span> <span class="k">public</span> <span class="n">lastPlayed</span><span class="p">;</span>
    <span class="kt">address</span> <span class="k">public</span> <span class="n">owner</span><span class="p">;</span>
    
    <span class="k">struct</span> <span class="n">Player</span> <span class="p">{</span>
        <span class="kt">address</span> <span class="n">addr</span><span class="p">;</span>
        <span class="kt">uint256</span> <span class="n">ethr</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="n">Player</span><span class="p">[]</span> <span class="n">players</span><span class="p">;</span>
    
    <span class="k">constructor</span><span class="p">()</span> <span class="k">public</span> <span class="p">{</span>
        <span class="c1">// On construct set the owner and a random secret number
</span>        <span class="n">owner</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">;</span>
        <span class="n">shuffle</span><span class="p">();</span>
    <span class="p">}</span>
    
    <span class="k">function</span> <span class="n">guess</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">number</span><span class="p">)</span> <span class="k">public</span> <span class="k">payable</span> <span class="p">{</span>
        <span class="c1">// Guessing costs a minimum of 1 ether 
</span>        <span class="nb">require</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="kc">ether</span><span class="p">);</span>
        
        <span class="c1">// Guess must be between zero and ten
</span>        <span class="nb">require</span><span class="p">(</span><span class="n">number</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">number</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">);</span>
        
        <span class="c1">// Update the last played date
</span>        <span class="n">lastPlayed</span> <span class="o">=</span> <span class="nb">now</span><span class="p">;</span>
        
        <span class="c1">// Add player to the players list
</span>        <span class="n">Player</span> <span class="n">player</span><span class="p">;</span>
        <span class="n">player</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">;</span>
        <span class="n">player</span><span class="p">.</span><span class="n">ethr</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
        <span class="n">players</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">player</span><span class="p">);</span>
        
        <span class="c1">// Payout if guess is correct
</span>        <span class="k">if</span> <span class="p">(</span><span class="n">number</span> <span class="o">==</span> <span class="n">secretNumber</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">.</span><span class="nb">transfer</span><span class="p">(</span><span class="nb">this</span><span class="p">.</span><span class="nb">balance</span><span class="p">);</span>
        <span class="p">}</span>
        
        <span class="c1">// Refresh the secret number
</span>        <span class="n">shuffle</span><span class="p">();</span>
    <span class="p">}</span>
    
    <span class="k">function</span> <span class="n">shuffle</span><span class="p">()</span> <span class="k">internal</span> <span class="p">{</span>
        <span class="c1">// Randomly set secretNumber with a value between 1 and 10
</span>        <span class="n">secretNumber</span> <span class="o">=</span> <span class="kt">uint8</span><span class="p">(</span><span class="nb">sha3</span><span class="p">(</span><span class="nb">now</span><span class="p">,</span> <span class="n">block</span><span class="p">.</span><span class="nb">blockhash</span><span class="p">(</span><span class="n">block</span><span class="p">.</span><span class="n">number</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">kill</span><span class="p">()</span> <span class="k">public</span> <span class="p">{</span>
        <span class="c1">// Enable owner to kill the contract after 24 hours of inactivity
</span>        <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span> <span class="o">==</span> <span class="n">owner</span> <span class="o">&amp;&amp;</span> <span class="nb">now</span> <span class="o">&gt;</span> <span class="n">lastPlayed</span> <span class="o">+</span> <span class="mi">24</span> <span class="kc">hours</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">selfdestruct</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure><h3 id="explanation">Explanation</h3><p>I’ll first explain how one would expect the contract to work.</p><ol><li>Someone constructs the contract.<ol><li>The variable <code class="language-plaintext highlighter-rouge">owner</code> is set to the sender’s address.</li><li>The method <code class="language-plaintext highlighter-rouge">shuffle</code> is called.<ol><li>The <code class="language-plaintext highlighter-rouge">shuffle</code> method sets <code class="language-plaintext highlighter-rouge">secretNumber</code> to a random number from 0 to 10.</li></ol></li></ol></li><li>A l33t h4x0r finds the smart contract by syncing the chain or by searching Etherscan.<ol><li>He finds out that you can win money if you know <code class="language-plaintext highlighter-rouge">secretNumber</code>.</li><li>There’s a pretty high chance he guesses the number right after a few times, but instead he decides to do something else.</li><li>Although the <code class="language-plaintext highlighter-rouge">secretNumber</code> is a private variable, he knows you can get it by <a href="https://medium.com/aigang-network/how-to-read-ethereum-contract-storage-44252c8af925" target="_blank" rel="noopener noreferrer">reading</a> the contract’s storage.</li><li>So he reads the storage and finds out the <code class="language-plaintext highlighter-rouge">secretNumber</code> is 6. <strong>Bingo!</strong></li><li>He calls the <code class="language-plaintext highlighter-rouge">play</code> method with 6 as <code class="language-plaintext highlighter-rouge">number</code> argument (and with 1.2 ether) and expects to get the ether from the contract.</li></ol></li></ol><p>Please note the <code class="language-plaintext highlighter-rouge">payable</code> keyword from the <code class="language-plaintext highlighter-rouge">play</code> method. It enables people to send ether to the method, which will then automatically be stored in the contract.</p><p>The big question is; did the l33t h4x0r outplay the contract’s creator/owner?</p><h3 id="the-scam">The scam</h3><p>Well, that ‘someone’ that constructed the contract wasn’t just someone. It was a scammer who used a ‘feature’ from Solidity to mislead everyone who played the game. There are at least three ways why people fall for this.</p><ol><li>One can keep calling the <code class="language-plaintext highlighter-rouge">play</code> method and bet on it that he eventually wins.</li><li>One knows that the <code class="language-plaintext highlighter-rouge">secretNumber</code> is not really random, since it’s made up of the date and the previous block hash.<ol><li>The person calculates the <code class="language-plaintext highlighter-rouge">secretNumber</code> by getting the variables it was made up of.</li><li>The person calls the <code class="language-plaintext highlighter-rouge">play</code> method using that number.</li></ol></li><li>One knows how to read the contract’s storage.<ol><li>The person reads the location of the <code class="language-plaintext highlighter-rouge">secretNumber</code> from the storage.</li><li>The person calls the <code class="language-plaintext highlighter-rouge">play</code> method using the number on that location.</li></ol></li></ol><p>Unfortunately none of these methods work.</p><h3 id="the-feature">The ‘feature’</h3><p>The scammer paid very much attention to the Solidity documentation.</p><p>The local variables of struct, array or mapping type reference storage <a href="https://solidity.readthedocs.io/en/latest/frequently-asked-questions.html#what-is-the-memory-keyword-what-does-it-do" target="_blank" rel="noopener noreferrer">by default</a>. This means they are stored in the contract’s storage.</p><p>The Solidity documentation also states that;</p><blockquote><p>The type of the local variable <code class="language-plaintext highlighter-rouge">player</code> is <code class="language-plaintext highlighter-rouge">Player</code> (stored in storage), but since storage is not dynamically allocated, it has to be assigned from a state variable before it can be used. So no space in storage will be allocated for <code class="language-plaintext highlighter-rouge">player</code>, but instead it functions only as an alias for a pre-existing variable in storage.</p></blockquote><blockquote><p>What will happen is that the compiler interprets <code class="language-plaintext highlighter-rouge">player</code> as a storage pointer and will make it point to the storage slot 0 by default. This has the effect that <code class="language-plaintext highlighter-rouge">secretNumber</code> (which resides at storage slot 0) is modified by <code class="language-plaintext highlighter-rouge">players.push(player)</code>.</p></blockquote><p>Please note that I modified the variable names in the quotes above to match the contract.</p><p>So to elaborate on this a little bit more. <code class="language-plaintext highlighter-rouge">Player player;</code> points to storage slot 0 because it’s an uninitialized storage variable. The <code class="language-plaintext highlighter-rouge">uint256 private secretNumber;</code> also points to storage slot 0 because it’s the first variable that is declared in the contract (and it’s also set on construct). This means whenever you change something in <code class="language-plaintext highlighter-rouge">player</code>, you will change the <code class="language-plaintext highlighter-rouge">secretNumber</code>.</p><p>In this case <code class="language-plaintext highlighter-rouge">player.addr = msg.sender;</code> is executed right after the <code class="language-plaintext highlighter-rouge">Player player;</code> line. This means storage slot 0 gets set to <code class="language-plaintext highlighter-rouge">msg.sender</code>. This leads to the fact that whenever you get <code class="language-plaintext highlighter-rouge">secretNumber</code> from the storage after that line of code was executed, it will give you the value of <code class="language-plaintext highlighter-rouge">msg.sender</code>.</p><h3 id="but-wait-theres-more">But wait, there’s more</h3><p>Why don’t we just call the <code class="language-plaintext highlighter-rouge">play</code> method with <code class="language-plaintext highlighter-rouge">msg.sender</code> as <code class="language-plaintext highlighter-rouge">number</code> argument.</p><p>In theory this could work. But keep in mind that the <code class="language-plaintext highlighter-rouge">play</code> function requires the number to be 10 or lower.</p><figure class="highlight"><pre><code class="language-solidity" data-lang="solidity"><span class="nb">require</span><span class="p">(</span><span class="n">number</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">number</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">);</span></code></pre></figure><p>This means that when your address (<code class="language-plaintext highlighter-rouge">msg.sender</code>) is 10 or lower you can win the ether in this contract.</p><p>In reality the chance is very very very little that your address is 10 or lower, and therefore you can (almost) never win ether from this contract.</p><h3 id="where-does-the-ether-go">Where does the ether go?</h3><p>There is a nice <code class="language-plaintext highlighter-rouge">kill</code> method that enables the contract’s creator to destruct the contract whenever the last played date is 24 hours ago. The self destruct sends all the money in the contract back to the owner of the contract (the attacker).</p></article><footer class="text-center mt-5 mb-5"><div class="footer-links"> <a href="/"><span>Posts</span></a> <a href="/about/" target="_self"><span>About</span></a> <a href="/donate/" target="_self"><span>Donate</span></a> <a href="/responsible-disclosure/" target="_self"><span>Responsible Disclosure</span></a></div><p class="footer-copyright text-secondary"> Copyright &copy; 2024 Tijme Gommers. All rights reserved.</p><div class="footer-icons"><div class="padding"> <a href="https://twitter.com/tijme" target="_blank" rel="noopener nofollow"> <span><span class="icon"> <svg><use xlink:href="/img/icons.svg#twitter"/></svg> </span></span> </a></div><div class="padding"> <a href="https://github.com/tijme" target="_blank" rel="noopener nofollow"> <span><span class="icon"> <svg><use xlink:href="/img/icons.svg#github"/></svg> </span></span> </a></div><div class="padding"> <a href="https://www.linkedin.com/in/tijme" target="_blank" rel="noopener nofollow"> <span><span class="icon"> <svg><use xlink:href="/img/icons.svg#linkedin"/></svg> </span></span> </a></div></div></footer></div></div></div></body></html>
